---
import AuthLayout from "@/layouts/AuthLayout.astro";
import ResetPasswordForm from "@/components/auth/ResetPasswordForm";
import { createSupabaseServerInstance } from "@/db/supabase.client";

export const prerender = false;

// Check if user has a valid session from reset link
// Supabase automatically sets the session when user clicks reset link
const supabase = createSupabaseServerInstance({
  headers: Astro.request.headers,
  cookies: Astro.cookies,
});

const {
  data: { session },
} = await supabase.auth.getSession();

// Check if this is a valid password reset session
// The session will exist if user came from valid reset email link
const isTokenValid = !!session;

// If user is already logged in normally (not from reset link),
// redirect to dashboard
if (Astro.locals.user && !Astro.url.searchParams.has("code")) {
  return Astro.redirect("/dashboard");
}
---

<AuthLayout title="Resetowanie hasÅ‚a">
  <ResetPasswordForm client:load isTokenValid={isTokenValid} />
</AuthLayout>

