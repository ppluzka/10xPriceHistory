---
import AuthLayout from "@/layouts/AuthLayout.astro";
import ResetPasswordForm from "@/components/auth/ResetPasswordForm";
import { createSupabaseServerInstance } from "@/db/supabase.client";

export const prerender = false;

// Check if user has a valid session from reset link
// Supabase automatically sets the session when user clicks reset link
const supabase = createSupabaseServerInstance({
  headers: Astro.request.headers,
  cookies: Astro.cookies,
  locals: Astro.locals,
});

// Use getUser() instead of getSession() for security - verifies with Auth server
const {
  data: { user },
} = await supabase.auth.getUser();

// Check if this is a valid password reset session
// The user will exist if they came from valid reset email link
const isTokenValid = !!user;

// If user is already logged in normally (not from reset link),
// redirect to dashboard
if (Astro.locals.user && !Astro.url.searchParams.has("code")) {
  return Astro.redirect("/dashboard");
}
---

<AuthLayout title="Resetowanie hasÅ‚a">
  <ResetPasswordForm client:load isTokenValid={isTokenValid} />
</AuthLayout>
