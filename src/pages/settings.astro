---
import Layout from "../layouts/Layout.astro";
import SettingsView from "../components/views/SettingsView";
import Header from "../components/navigation/Header";
import type { PreferencesDto } from "../types";

export const prerender = false;

// Get user from middleware (added by auth middleware)
// Middleware ensures user is always present on protected routes
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

// Fetch initial preferences data server-side
let initialPreferences: PreferencesDto | null = null;
let error: string | null = null;

try {
  // Use current request protocol to support both HTTP and HTTPS
  // x-forwarded-proto is set by nginx when redirecting HTTP to HTTPS
  const forwardedProto = Astro.request.headers.get("x-forwarded-proto");
  const protocol = forwardedProto ? `${forwardedProto}:` : Astro.url.protocol;
  const origin = `${protocol}//${Astro.url.host}`;
  const response = await fetch(`${origin}/api/preferences`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (response.ok) {
    initialPreferences = await response.json();
  } else {
    error = "Failed to load preferences";
  }
} catch (e) {
  console.error("Error fetching preferences:", e);
  error = "Failed to load preferences";
}
---

<Layout title="Ustawienia - PriceHistory">
  <Header client:load user={{ email: user.email, id: user.id }} />
  {
    error ? (
      <div class="container mx-auto px-4 py-8">
        <div class="text-center text-destructive">
          <p>{error}</p>
        </div>
      </div>
    ) : (
      <SettingsView client:load initialPreferences={initialPreferences} />
    )
  }
</Layout>
