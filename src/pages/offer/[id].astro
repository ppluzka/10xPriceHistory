---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/navigation/Header";
import OfferDetailsPage from "../../components/offer/OfferDetailsPage";
import type { OfferDetailDto, PaginatedDto, PriceHistoryDto } from "../../types";

export const prerender = false;

// Get user from middleware (added by auth middleware)
// Middleware ensures user is always present on protected routes
const user = Astro.locals.user!;

// Get offer ID from URL params
const { id } = Astro.params;

// Validate offer ID
if (!id) {
  return Astro.redirect("/dashboard");
}

// Fetch offer details and history server-side
let offerData: OfferDetailDto | null = null;
let historyData: PaginatedDto<PriceHistoryDto> | null = null;
let error: string | null = null;
let statusCode = 200;

try {
  // Fetch offer details
  const offerResponse = await fetch(`${Astro.url.origin}/api/offers/${id}`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (offerResponse.status === 404) {
    statusCode = 404;
    error = "Offer not found";
  } else if (offerResponse.status === 403) {
    statusCode = 403;
    error = "You don't have access to this offer";
  } else if (!offerResponse.ok) {
    statusCode = 500;
    error = "Failed to load offer details";
  } else {
    offerData = await offerResponse.json();

    // Fetch price history (get all records for chart)
    const historyResponse = await fetch(`${Astro.url.origin}/api/offers/${id}/history?size=1000`, {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    if (historyResponse.ok) {
      historyData = await historyResponse.json();
    } else {
      // History is optional, we can still show the offer without it
      historyData = {
        data: [],
        page: 1,
        size: 0,
        total: 0,
      };
    }
  }
} catch (e) {
  // Log error on server side
  if (import.meta.env.DEV) {
    // eslint-disable-next-line no-console
    console.error("Error fetching offer data:", e);
  }
  statusCode = 500;
  error = "Failed to load offer details";
}

// Set response status if there's an error
if (error || !offerData || !historyData) {
  Astro.response.status = statusCode;
}

// Determine if we should show error page
const showErrorPage = error || !offerData || !historyData;
---

{
  showErrorPage ? (
    <Layout title="Error - 10x Price History">
      <Header client:load user={{ email: user.email, id: user.id }} />
      <div class="container mx-auto px-4 py-8">
        <div class="text-center">
          <h1 class="text-3xl font-bold mb-4">
            {statusCode === 404 ? "Oferta nie znaleziona" : "Błąd"}
          </h1>
          <p class="text-muted-foreground mb-6">
            {error || "Wystąpił błąd podczas ładowania oferty"}
          </p>
        </div>
      </div>
    </Layout>
  ) : (
    <Layout title={`${offerData!.title} - 10x Price History`}>
      <Header client:load user={{ email: user.email, id: user.id }} />
      <OfferDetailsPage client:load initialOffer={offerData!} initialHistory={historyData!} />
    </Layout>
  )
}
